<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Feedback</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f7f8fa;color:#222;padding:20px}
        .container{max-width:700px;margin:0 auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.06)}
        label{display:block;margin-top:12px;font-weight:600}
        textarea{width:100%;min-height:100px;padding:8px;box-sizing:border-box}
        input[type=text], input[type=email]{width:100%;padding:8px;box-sizing:border-box}
        .rating {display:flex;gap:8px;margin-top:8px}
        .btn{background:#0078d4;color:#fff;padding:10px 14px;border:none;border-radius:6px;cursor:pointer}
        .msg{margin-top:12px}
        .list{margin-top:18px}
        .item{background:#fafafa;padding:12px;border-radius:6px;margin-bottom:8px;border:1px solid #eee}
        .meta{color:#666;font-size:13px}
    </style>
</head>
<body>
    <div class="container">
        <h1>Feedback</h1>
        <p>We'd love to hear about your experience. Please leave a rating and any comments.</p>

        <form id="feedbackForm">
            <label for="rating">Rating</label>
            <div class="rating" id="rating">
                <label><input type="radio" name="rating" value="5" checked> 5</label>
                <label><input type="radio" name="rating" value="4"> 4</label>
                <label><input type="radio" name="rating" value="3"> 3</label>
                <label><input type="radio" name="rating" value="2"> 2</label>
                <label><input type="radio" name="rating" value="1"> 1</label>
            </div>

            <label for="comments">Comments</label>
            <textarea id="comments" placeholder="Tell us what went well or how we can improve."></textarea>

            <label for="name">Your name (optional)</label>
            <input type="text" id="name" placeholder="Name">

            <label for="email">Email (optional)</label>
            <input type="email" id="email" placeholder="you@example.com">

            <div style="margin-top:12px;display:flex;gap:8px;">
                <button class="btn" type="submit">Send Feedback</button>
                <button id="clearBtn" type="button" style="background:#e0e0e0;color:#000">Clear</button>
            </div>
        </form>

        <div class="msg" id="msg"></div>

        <section class="list">
            <h3>Recent Feedback</h3>
            <div id="feedbackList"></div>
        </section>
    </div>

    <script>
        // Prefill name if logged in
        if(localStorage.getItem('username')) {
            document.getElementById('name').value = localStorage.getItem('username');
        }

        async function loadFeedbacks(){
            const list = document.getElementById('feedbackList');
            list.innerHTML = '';
            try{
                const res = await fetch('/api/feedbacks');
                if(!res.ok) throw new Error('Failed to load feedbacks');
                const all = await res.json();
                if(!all || all.length === 0){ list.innerHTML = '<div class="item">No feedback yet.</div>'; return; }
                all.slice().reverse().forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
                        <div style="font-weight:700">${escapeHtml(f.name || 'Anonymous')} — ${f.rating}★</div>
                        <div class="meta">${new Date(f.createdAt || f.date).toLocaleString()} ${f.email ? '• ' + escapeHtml(f.email) : ''}</div>
                        <div style="margin-top:8px">${escapeHtml(f.comments || '')}</div>
                    `;
                    list.appendChild(div);
                });
            }catch(err){ console.error(err); list.innerHTML = '<div class="item">Failed to load feedback.</div>'; }
        }

        function escapeHtml(str){
            if(!str) return '';
            return str.replace(/[&<>"']/g, function(c){
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c];
            });
        }

        document.getElementById('feedbackForm').addEventListener('submit', async function(e){
            e.preventDefault();
            const rating = document.querySelector('input[name="rating"]:checked').value;
            const comments = document.getElementById('comments').value.trim();
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const payload = { rating: parseInt(rating,10), comments, name, email };
            try{
                const res = await fetch('/api/feedbacks', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)});
                if(!res.ok) throw new Error('Server returned ' + res.status);
                document.getElementById('msg').textContent = 'Thanks — your feedback has been received.';
                document.getElementById('feedbackForm').reset();
                if(localStorage.getItem('username')) document.getElementById('name').value = localStorage.getItem('username');
                await loadFeedbacks();
            }catch(err){ console.error(err); document.getElementById('msg').textContent = 'Failed to send feedback.'; }
        });

        document.getElementById('clearBtn').addEventListener('click', function(){
            document.getElementById('feedbackForm').reset();
            if(localStorage.getItem('username')) document.getElementById('name').value = localStorage.getItem('username');
            document.getElementById('msg').textContent = '';
        });

    // Initial load
    loadFeedbacks();
    </script>
</body>
</html>